<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
    <title>添加设备</title>
    <meta name="keywords" content="jqGrid表格,表格插件" />
    <!--<link rel="stylesheet" type="text/css" href="http://www.sucaihuo.com/jquery/css/common.css" />-->
    <link rel="stylesheet" type="text/css" href="css/ui-lightness/jquery-ui-1.8.2.custom.css" />
    <link rel="stylesheet" type="text/css" href="css/ui.jqgrid.css" />
    <link rel="stylesheet" type="text/css" href="css/fancybox.css" />
    <!-- 新页面css -->
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/addDev.css">
    <script type="text/javascript" src="http://www.sucaihuo.com/Public/js/other/jquery.js"></script> 
    <script src="js/i18n/grid.locale-cn.js" type="text/javascript"></script>
    <script src="js/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="js/jquery.fancybox.js" type="text/javascript"></script>
    <script src="js/jquery.message.js" type="text/javascript"></script>

</head>
<?php 
	session_start(); 
	if($_SESSION['UserName'])
	$tempstr=1;
	//$tempstr=0;
	else $tempstr=0;
?>
<body>
    <div class="center public-width" id="container">
        <div id="left">
            <div id="logo">
                <img src="../img/common/logo_黑底.png"/>
            </div>
            <div id="menu-box">
                <ul id="menu">
                    <!--管理员菜单-->
                    <?php
                        session_start();
                        include_once ("../connect.php");
                        $result = mysql_query("SELECT * FROM use_login WHERE UserName ='".$_SESSION['UserName']."'  ");
                        $row = mysql_fetch_array($result, MYSQL_ASSOC);
                        $count = $row['Role'];
                        if($count==1){
                    ?>
                   <li><a id="userMap" href="../UserMap/user_map.html">用户地图</a></li>
                    <li><a class="devMap" href="../DevMap_admin/devMap_admin.html">设备地图</a></li>
                    <li><a class="search" href="../searchInfo/searchInfo.html">信息搜索</a></li>
                    <li><a id="saleRank" href="../rank/rank.html">销售排名</a></li>
                    <li><a class="userLogs" href="../logmanage/infor.html">用户日志</a></li>
                    <li><a class="modifyInfo" href="../infocompli/changeAdminInfor.html">修改管理员信息</a></li>
                    <li><a class="appDownLoad" href="../QRcode/appDownLoad.html">移动APP下载</a></li>
                    <!--
                        作者：1763257419@qq.com
                        时间：2018-03-30
                        描述：二级用户菜单
                    -->
                    <?php
                         }else if($count==2){
                    ?>
                   <li><a id="addUser" href="../UserManage/UserManage.html">添加用户</a></li>
                    <li><a id="addDev" href="../Adddevice/index.html">添加设备</a></li>
                    <li><a class="devMap" href="../DevMap/dev_map.html">设备地图</a></li>
                    <li><a class="devList" href="../devlist/index_devlist.html">设备列表</a></li>
                    <li><a class="modifyInfo" href="../infocompli/infor.html">修改用户信息</a></li>
                    <li><a class="userLogs" href="../logmanage/infor.html">用户日志</a></li>
                    <li><a class="appDownLoad" href="../QRcode/appDownLoad.html">移动APP下载</a></li>
                    <li><a class="QA" href="../QA/news.html">QA模块</a></li>
                    <li><a class="feedback" href="../OA/index.html">现场用户信息反馈</a></li>
                    <!--
                        作者：1763257419@qq.com
                        时间：2018-03-30
                        描述：三级用户菜单
                    -->
                    <?php
                        }else if($count==3){
                    ?>
                   <li><a class="devMap" href="../DevMap/dev_map.html">设备地图</a></li>
                    <li><a class="devList" href="../devlist/index_devlist.html">设备列表</a></li>
                    <li><a class="modifyInfo" href="../infocompli/infor.html">修改用户信息</a></li>
                    <li><a class="userLogs" href="../logmanage/infor.html">用户日志</a></li>
                    <li><a class="appDownLoad" href="../QRcode/appDownLoad.html">移动APP下载</a></li>
					<li><a class="QA" href="../QA/news.html">QA模块</a></li>
                    <li><a class="devInfoFeedBack" href="../devInfoFeedBack/devInfoFeedBack.html">设备信息反馈</a></li>
                    <?php
                        }
                    ?>
                </ul>
            </div>
        </div>
        <div id="right">
            <div id="title">
                <div id="list-icon">
                    <a href="../main.html"><img src="../img/common/list-title.png"/></a>
                </div>
                <h1>亿维自动化物联网云平台</h1>
                <div id="userinfo-box">
                    <div id="head-icon">
                        <a href="../main.html"><img src="../img/common/驯鹿.png"/></a>
                    </div>
                    <div id="user-info">
                        <li class="list" id="user-name">
                            <?php echo $_SESSION['UserName'];?>
                            <ul>
                                <li class="list"><a id="out" href="../exit.php">退出登录</a></li>
                            </ul>
                        </li>
                    </div>
                </div>
            </div>
            <div id="main-box">
                <div id="addDev-title" class="title">
                    <p>添加设备</p>
                </div>
                <div id="addDev-body">
                    <div id="btn">
                        <a id="add-dev" href="../DevReg/DevReg.html"><p>添加设备</p></a>
                        <a id="delete-dev" ><p>删除设备</p></a>
                        <a id="modify-info" onclick="document.getElementById('light').style.display='block';
    document.getElementById('fade').style.display='block'"><p>修改信息</p></a>
                        <div id="light" class="white_content">
                            <a href = "javascript:void(0)" onclick = "document.getElementById('light').style.display='none';
   document.getElementById('fade').style.display='none'">x</a>

                           <h3>修改信息</h3>
                            <div class="input-info">
                               <p>现场名称</p><input type="text" name="" id="siteName" value="">
                            </div>
                            <div class="input-info">
                                <p>行业类型</p><input type="text" name="" id="indusType" value="">
                            </div>
                            <div class="input-info">
                                <p>设备地址</p><input type="text" name="" id="devAddress" value="">
                            </div>
                            <div class="input-info">
                                <input type="button" name="" id="submitInfo" value="提交" onclick="submit()">
                            </div>
                        </div> 
                        <div id="fade" class="black_overlay"></div> 
                    </div>
                    <div id="addDev-grid">
                        <table id="list"></table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
 <script type="text/javascript">



 var teststr=<?php echo $tempstr;?>;
if(teststr==0)
{
window.location.href="../index.html";
}
    // 退出登录的下拉效果
    $(function(){
        $('.list').hover(function(){
            $(this).children('ul').stop().slideDown('fast');
        },function(){
            $(this).children('ul').stop().slideUp('fast');
        });
    });

            $("#list").jqGrid({
                url: 'do.php?action=list', //请求数据的url地址
                datatype: "json", //请求的数据类型
                colNames: ['SN', '设备型号','校验码', '时间','现场名称','行业类型','地址','经度','纬度','运行状态'], //数据列名称（数组）
                //colNames: ['SN', '校验码', '时间'], 
                colModel: [//数据列各参数信息设置
                    {name: 'SN', index: 'SN', width: 80, align: 'center'},
                    {name: 'DevType', index: 'DevType',  width: 100, align: 'center'},
                    {name: 'CheckCode', index: 'CheckCode', width: 80, align: 'center'},
                    {name: 'Time', index: 'Time', width: 160,align: 'center'},
                    {name: 'LocalName', index: 'LocalName', width: 80,align: 'center'},
                    {name: 'IndustryType', index: 'IndustryType', width: 80,align: 'center'},
                    {name: 'Address', index: 'Address', width: 200,align: 'center'},
                    {name: 'Longtitude', index: 'Longtitude', width: 80,align: 'center'},
                    {name: 'Latitude', index: 'Latitude', width: 80,align: 'center'},
                    {name: 'RunStatus', index: 'RunStatus', width: 80,align: 'center'},
                ],
               
                rowNum:-1,
                autowidth: true, //自动匹配宽度
                height: 450, //设置高度
                gridview: true, //加速显示
                viewrecords: true, //显示总记录数
                //multiselect: true, //可多选，出现多选框
                multiselectWidth: 25 //设置多选列宽度
                //sortable: true, //可以排序
                //sortname: 'id', //排序字段名
                //sortorder: "desc", //排序方式：倒序，本例中设置默认按id倒序排序
                /*loadComplete: function(data) { //完成服务器请求后，回调函数
                    if (data.records == 0) { //如果没有记录返回，追加提示信息，删除按钮不可用
                        $("p").appendTo($("#list")).addClass("nodata").html('找不到相关数据！');
                        $("#delete-dev").attr("disabled", true);
                    } else { //否则，删除提示，删除按钮可用
                        $("p.nodata").remove();
                        $("#delete-dev").removeAttr("disabled");
                    }
                }*/
            });

           $(function() {
                $("#add_btn").click(function() {
                    $.fancybox({
                        'type': 'ajax',
                       'href': 'addGrid.html'
                    });
                });
        
    $("#delete-dev").click(function() {//删除设备
        var sels = $("#list").jqGrid('getGridParam', 'selrow');
        var rowData = $('#list').jqGrid('getRowData',sels);
    if(sels){
        var SNdel=rowData.SN;
        //alert(user3name);
        if (sels == "") {
            alert('请选择要删除的项！')
        } else {
            if (confirm("您是否确认删除？")) {
                $.ajax({
                    type: "POST",
                    url: "do.php?action=del",
                    data: {"SNdel":SNdel},
                
                    beforeSend: function() {
                        $().message("正在请求...");
                    },
                    error: function() {
                        $().message("请求失败...");
                    },
                    success: function(msg) {
                        if (msg != 0) { 
                                    $().message("已成功删除!");
                                    jQuery("#list").jqGrid( 'setGridParam', { url : 'do.php?action=list', page : 1 }).trigger("reloadGrid");   
                        } else {
                            $().message("操作失败！");
                        }
                    }
                });
            }
        }
        }else {alert("您没有选择设备!");}
});
/////
                $("#find_btn").click(function() {
                    var title = escape($("#title").val());
                    var sn = escape($("#sn").val());
                    $("#list").jqGrid('setGridParam', {
                        url: "do.php?action=list",
                        postData: {'title': title, 'sn': sn},
                        page: 1
                    }).trigger("reloadGrid");
                    // document.getElementById('fade').style.display='none'；
                });
            });
////////////////////////////关页面			
var clientX = 0;
var clientY = 0;

window.onmousedown = function (event) {
      event = event || window.event;
      clientX = event.clientX;
      clientY = event.clientY;
}

window.onbeforeunload = function () {
if( clientY < 20){
	$.ajax({
	type:"POST",
	url:"../cleansession.php",
	data: {"clean":"退出登录"},
	dataType:"json",
	async:false,
	success:function(data)
	{						
	}
	});	
}
};

//弹出修改信息框
function open(){
    document.getElementById('light').style.display='block';
    document.getElementById('fade').style.display='block';
}


//关闭修改信息框
function close(){
   document.getElementById('light').style.display='none';
   document.getElementById('fade').style.display='none';
}

//提交需要修改的信息
function submit(){
    //获取选中行的SN号
    var sels = $("#list").jqGrid('getGridParam', 'selrow');
    var rowData = $('#list').jqGrid('getRowData',sels);
    if(sels){
        var selectedSN=rowData.SN;
        var siteName=document.getElementById('siteName').value;
        var indusType=document.getElementById('indusType').value;
        var devAddress=document.getElementById('devAddress').value;
          if (siteName&&indusType&&devAddress) {
                $.ajax({
                    type: "POST",
                    url: "addDev-modifyInfo.php",
                    dataType:"json",
                    data: {
                        "SN":selectedSN,
                        "SiteName":siteName,
                        "IndusType":indusType,
                        "DevAddr":devAddress
                    },
                    success: function(data) {
                        if(data.state==200)
                        {
                            alert('修改成功');
                            $("#list").jqGrid('setGridParam',{  
                            url:'do.php?action=list' ,     
                            datatype:'json',    
                            page:1    
                            }).trigger("reloadGrid");  
                            close();
                        }else
                        {
                            alert('修改失败');
                        }
                    }
                });

            }else
            {
                    alert('信息未填写完整');    
            }
    } else
    {
        alert('请选择需要修改的设备');    
    }
}



</script>