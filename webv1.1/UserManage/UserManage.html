<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head> 
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
        <title>添加客户</title>
        <link rel="stylesheet" type="text/css" href="../css/common.css">
        <link rel="stylesheet" type="text/css" href="../css/addUser.css">
        <!--<link rel="stylesheet" type="text/css" href="css/style.css" />-->
		<link rel="stylesheet" type="text/css" href="css/ui-lightness/jquery-ui-1.8.2.custom.css" />
        <link rel="stylesheet" type="text/css" href="css/ui.jqgrid.css" />
        <link rel="stylesheet" type="text/css" href="css/fancybox.css" />			
		<!--<link rel="stylesheet" href="jqgrid/css/css/redmond/jquery-ui-1.8.16.custom.css" />-->
		<script type="text/javascript" src="http://www.sucaihuo.com/Public/js/other/jquery.js"></script> 
        <script src="js/i18n/grid.locale-cn.js" type="text/javascript"></script>
        <script src="js/jquery.jqGrid.min.js" type="text/javascript"></script>
        <script src="js/jquery.fancybox.js" type="text/javascript"></script>
        <script src="js/jquery.message.js" type="text/javascript"></script>
		<script src="js/jquery.contextMenu.js" type="text/javascript"></script>  
		<script type="text/javascript" src="jqgrid/js/jquery.jqGrid.src.js"></script>
		

    </head>
		 <?php 
	session_start(); 
	if($_SESSION['UserName'])
	$tempstr=1;
	//$tempstr=0;
	else $tempstr=0;
?>
<body>
	<div class="center public-width" id="container">
		<div id="left">
			<div id="logo" style="height: 50px;width: 150px;margin-left: 0px">
				<img src="../img/common/logo_黑底.png" style="width: 150px;height: 50px;margin-left:30px;margin-right:auto;" />
			</div>
			<div id="menu-box">
				<ul id="menu">
					<!--管理员菜单-->
					<?php
						session_start();
						include_once ("../connect.php");
						$result = mysql_query("SELECT * FROM use_login WHERE UserName ='".$_SESSION['UserName']."'  ");
						$row = mysql_fetch_array($result, MYSQL_ASSOC);
						$count = $row['Role'];
						if($count==1){
					?>
					<li><a id="userMap" href="../UserMap/user_map.html">客户地图</a></li>
					<li><a class="devMap" href="../DevMap_admin/devMap_admin.html">设备地图</a></li>
					<li><a class="search" href="../searchInfo/searchInfo.html">信息搜索</a></li>
					<li><a id="saleRank" href="../rank/rank.html">销售排名</a></li>
					<li><a class="userLogs" href="../logmanage/infor.html">客户日志</a></li>
					<li><a class="modifyInfo" href="../infocompli/changeAdminInfor.html">修改管理员信息</a></li>
					<li><a class="appDownLoad" href="../QRcode/appDownLoad.html">移动APP下载</a></li>
					<!--
                    	作者：1763257419@qq.com
                    	时间：2018-03-30
                    	描述：二级客户菜单
                    -->
                	<?php
				   		 }else if($count==2){
				    ?>
                   <li><a id="addUser" href="../UserManage/UserManage.html">添加客户</a></li>
                    <li><a id="addDev" href="../Adddevice/index.html">添加设备</a></li>
                    <li><a class="devMap" href="../DevMap/dev_map.html">设备地图</a></li>
                    <li><a class="devList" href="../devlist/index_devlist.html">设备列表</a></li>
                    <li><a class="modifyInfo" href="../infocompli/infor.html">修改客户信息</a></li>
                    <li><a class="userLogs" href="../logmanage/infor.html">客户日志</a></li>
                    <li><a class="appDownLoad" href="../QRcode/appDownLoad.html">移动APP下载</a></li>
                    <li><a class="QA" href="../QA/news.html">客户问题跟踪</a></li>
                    <li><a class="feedback" href="../OA/index.html">客户信息反馈</a></li>
                    <!--
                    	作者：1763257419@qq.com
                    	时间：2018-03-30
                    	描述：三级客户菜单
                    -->
                	<?php
					    }else if($count==3){
					?>
					<li><a class="devMap" href="../DevMap/dev_map.html">设备地图</a></li>
                    <li><a class="devList" href="../devlist/index_devlist.html">设备列表</a></li>
                    <li><a class="modifyInfo" href="../infocompli/infor.html">修改客户信息</a></li>
                    <li><a class="userLogs" href="../logmanage/infor.html">客户日志</a></li>
                    <li><a class="appDownLoad" href="../QRcode/appDownLoad.html">移动APP下载</a></li>
					<li><a class="QA" href="../QA/news.html">客户问题跟踪</a></li>
                    <li><a class="devInfoFeedBack" href="../devInfoFeedBack/devInfoFeedBack.html">设备信息反馈</a></li>
                    <?php
				    	}
				    ?>
				</ul>
			</div>
		</div>
		<div id="right">
			<div id="title">
				<div id="list-icon">
					<a href="../main.html"><img src="../img/common/list-title.png"/></a>
				</div>
				<h1>亿维自动化物联网云平台</h1>
				<div id="userinfo-box">
					<div id="head-icon">
						<a href="../main.html"><img src="../img/common/驯鹿.png"/></a>
					</div>
					<div id="user-info">
						<li class="list" id="user-name">
							<?php echo $_SESSION['UserName'];?>
							<ul>
								<li class="list"><a id="out" href="../exit.php">退出登录</a></li>
							</ul>
						</li>
					</div>
				</div>
			</div>
			<div id="main-box">
				<div id="addUser-title" class="title">
					<p>添加客户</p>
				</div>
				<div id="addUser-body">
					<div id="act-box">
						<div id="search">
							<select id="search-type">
								<option value="0">所有信息</option>
								<option value="1">客户名</option>
								<!--<option value="2">真实姓名</option>
								<option value="3">手机号码</option>
								<option value="4">邮箱</option>
								<option value="5">公司</option>
								<option value="6">行业类型</option>-->
							</select>
							<input type="text" id="inputstr" class="search-content" placeholder="请输入您要搜索的信息" name="search-content"/>
							<input type="button"  id="searchinfo" class="search-btn" value="搜索" name="search-btn">
						</div>
						<div id="btn">
							<a id="add-user" href="../adduser/Adduser.html"><p>新增客户</p></a>
							<a id="delete-user" href="#"><p>删除客户</p></a>
							<a id="add-dev" href="#"><p>添加设备</p></a>
							<a id="delete-dev" href="#"><p>删除设备</p></a>
						</div>
					</div>
					<div id="addUser-grid">
						<table id="list"></table><br>
                    	
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
 var teststr=<?php echo $tempstr;?>;
if(teststr==0)
{
window.location.href="../index.html";
}
// 退出登录的下拉效果
	$(function(){
		$('.list').hover(function(){
			$(this).children('ul').stop().slideDown('fast');
		},function(){
			$(this).children('ul').stop().slideUp('fast');
		});
	});
	
//////////////////////////////////////全局变量///////
var hol_name3;
var hol_dev;

////////////////////////////////////////////////////		
		
	
$(document).ready(function() {
var row_state=1,subrow_state=1;
///////////////////////////////////客户表//////////////////////////////////////////////
jQuery("#list").jqGrid( {
		url : 'do.php?action=list', 
		datatype : "json", 
		colNames : [ '序号', '客户名', '真实姓名', '手机号码', '邮箱', '公司', '行业类型'], 
		colModel : [ 
		{name: 'Num', index: 'Num', editable: true, width: 50, align: 'center', title: false,search:true, stype:'text',sortable:false},
		{name: 'UserName', index: 'UserName', width: 100, align: 'center',title: false  ,sortable:false},
		{name: 'Name', index: 'Name', width: 100,align: 'center',sortable:false},
		{name: 'Phone', index: 'Phone', width: 130,align: 'center',sortable:false},
		{name: 'Email', index: 'Email', width: 180, align: 'center',sortable:false},
		{name: 'Company', index: 'Company', width: 200, align: 'center',sortable:false},
		{name: 'IndustryType', index: 'IndustryType', width: 100, sortable: false, align: 'center',sortable:false}
		],
		rowNum:-1,
		autowidth: true, //自动匹配宽度
		height: 450, //设置高度
		gridview: true, //加速显示
		viewrecords: true, //显示总记录数
		//multiselectWidth: 25, //设置多选列宽度
		//sortable: true, //可以排序
		//sortname: 'id', //排序字段名
		//sortorder: "desc", //排序方式：倒序，本例中设置默认按id倒序排序
		multiselect : false, 
		subGrid : true, 
		subGridRowExpanded: function(subgrid_id, row_id) {
			var subgrid_table_id;
				subgrid_table_id = subgrid_id + "_t";
				var subgrid_pager_id;  
				//alert(subgrid_id);
				subgrid_pager_id = subgrid_id + "_pgr";
				liststr=subgrid_id.split("_");
				var rowDatastr = $('#list').jqGrid('getRowData',liststr[1]);
				var user3namestr=rowDatastr.UserName;
				
				
				$("#" + subgrid_id).html("<table id= '"+subgrid_table_id+"'></table><div id='"+subgrid_pager_id+"'></div>");  
					$("#" + subgrid_table_id).jqGrid({  
					        url:'device.php?user3namestr='+user3namestr,
							datatype: "json",
							 colNames: ['SN', '现场名称', '行业类型', '地址'],
							//colNames: [data],
							colModel: [
													{name: 'SNcode', index: 'SNcode', width: 100,align: 'center'},
													{name: 'LocalName', index: 'LocalName', width: 150,align: 'center'},
													{name: 'IndustryTypesub', index: 'IndustryTypesub', width: 100, align: 'center'},
													{name: 'Addresssub', index: 'Addresssub', width: 400, align: 'center'}
											],
														
														autowidth: true, //自动匹配宽度
														height: 100, //设置高度
														gridview: true, //加速显示
														multiselectWidth: 25, //设置多选列宽度
														//sortable: true, //可以排序
														multiselect : false, 
														//pager : '#'+subgrid_pager_id, 
														viewrecords : true, 
													    rowNum:-1,
										
														//  sortname: 'num',
														//  sortorder: "asc",
														  
														  onSelectRow : function(num) { 
														  row_state=!row_state;
															if(row_state){
															$("#" + subgrid_table_id).resetSelection();}
														    var rowID,list;															
															list=subgrid_id.split("_");
															var rowData = $('#list').jqGrid('getRowData',list[1]);
															hol_name3=rowData.UserName;//
															var sels = $("#" + subgrid_id+"_t").jqGrid('getGridParam','selrow');
															rowData = $("#" + subgrid_id+"_t").jqGrid('getRowData',sels);
															hol_dev=rowData.SNcode;//
															
														}
											
					});
				//	jQuery("#"+ subgrid_table_id).jqGrid('navGrid', '#'+subgrid_pager_id, { add : false, edit : false, del : false });
				
		},
		
		
		onSelectRow : function(id) { 
		
		row_state=!row_state;
		if(row_state){
		$("#list").resetSelection();}
		
		},
		
		
		}); 
		
});
 
///////////////////////////////////设备表//////////////////////////////////////////////	
$("#fbox_list_search").click(function () {
　//alert("hello");
　　});	
   

////////////////////按键功能//////////////////////////////////////
$(function() {

	$("#delete-user").click(function() {//删除客户
		var sels = $("#list").jqGrid('getGridParam', 'selrow');
		var rowData = $('#list').jqGrid('getRowData',sels);
		var user3name=rowData.UserName;
		if(user3name){
		//alert(user3name);
		if (sels == "") {
			alert('请选择要删除的项！')
		} else {
			if (confirm("您是否确认删除？")) {
				$.ajax({
					type: "POST",
					url: "do.php?action=del",
					data: {"ids":sels,"usr3name":user3name},
				
					beforeSend: function() {
						$().message("正在请求...");
					},
					error: function() {
						$().message("请求失败...");
					},
					success: function(msg) {
						if (msg != 0) {	
									$().message("已成功删除!");
									jQuery("#list").jqGrid( 'setGridParam', { url : 'do.php?action=list', page : 1 }).trigger("reloadGrid");   
						} else {
							$().message("操作失败！");
						}
					}
				});
			}
		}
		}
		else alert("请选中要删除的客户");
});

$("#add-dev").click(function() {//添加设备
var sels = $("#list").jqGrid('getGridParam', 'selrow');
var rowData = $('#list').jqGrid('getRowData',sels);
var user3name=rowData.UserName;
if(user3name){
//alert(user3name);
	$.fancybox({
		'type': 'ajax',
		'href': 'add.html?user3str='+"'"+user3name+"'"
		//'href': 'add.html'//user3str='+user3name
	});
	}
	else alert("没有选择需要添加设备的客户");
});
$("#delete-dev").click(function() {//删除设备
if(hol_dev && hol_name3){
var string='客户名'+hol_name3+'下的设备'+hol_dev+'将被解除绑定！';
	//alert(string);
		
				if (confirm("您是否确认解除绑定？")) {
					$.ajax({
						type: "POST",
						url: "do.php?action=deldev",
						data: {"name3":hol_name3,"devstring":hol_dev},
					
						beforeSend: function() {
							$().message("正在请求...");
						},
						error: function() {
							$().message("请求失败...");
						},
						success: function(msg) {
							if (msg != 0) {
									$().message("已成功删除!");
									jQuery("#list").jqGrid( 'setGridParam', { url : 'do.php?action=list', page : 1 }).trigger("reloadGrid");   
							} else {
								$().message("操作失败！");
							}
						}
					});
				}
		}	
		else alert("未指明客户下的设备");
	});
	
	////搜索
$("#searchinfo").click(function() {//搜素
var search_type=document.getElementById('search-type').value;
var inputstr=document.getElementById('inputstr').value;
strJQGrid = 'search.php?search_type='+search_type+' && inputstr='+inputstr;
		$("#list").jqGrid('setGridParam',{  
		url:strJQGrid , 	
		datatype:'json',    
		page:1    
		}).trigger("reloadGrid");  		
	
});
	
});



////////////////////////////关页面			
var clientX = 0;
var clientY = 0;

window.onmousedown = function (event) {
      event = event || window.event;
      clientX = event.clientX;
      clientY = event.clientY;
}

window.onbeforeunload = function () {
if( clientY < 20){
	$.ajax({
	type:"POST",
	url:"../cleansession.php",
	data: {"clean":"退出登录"},
	dataType:"json",
	async:false,
	success:function(data)
	{						
	}
	});	
}
};
        </script>
   
</html>
